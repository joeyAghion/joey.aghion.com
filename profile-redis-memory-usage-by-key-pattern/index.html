<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Profile Redis memory usage by key pattern</title>
    
    <link href='http://fonts.googleapis.com/css?family=Droid+Serif:400,700|Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link href="/stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/all.js" type="text/javascript"></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Half a Mind - Joey Aghion">
  </head>
  <body>
    <div class="wrapper">
      <header>
        <a href="/">
          <img src="/images/joey.jpg" width="75" height="75" alt="Joey Aghion" />
        </a>
        <h1><a href="/">Half a Mind</a></h1>
        by <a href="mailto:joey@aghion.com">Joey Aghion</a>
      </header>
      <section>
          <h2>
    <a href="/profile-redis-memory-usage-by-key-pattern/">Profile Redis memory usage by key pattern</a>
  </h2>
  <time datetime="2010-10-13" pubdate>Oct 13, 2010</time>
  <article>
    <p>At <a href='http://www.weplay.com'>Weplay</a>, we use <a href='http://code.google.com/p/redis/'>Redis</a> quite a bit. As a Redis database grows, though, it can be difficult to understand how the space is being used. This script tries to identify which types of keys are occupying the most space in your Redis databases. To do so, it takes a random sample of keys and collapses them into similar patterns (basically by ignoring the numeric values).</p>

<p>Sample output:</p>

<pre><code>Profiling &quot;db0&quot;...
--------------------
---
- - User:#:cached_preferences
  - keys: 1715
    size: 36015
    percent: 54.11%
- - Poll:#:results
  - keys: 555
    size: 27750
    percent: 41.69%
- - Group:#:member_ids
  - keys: 1645
    size: 1645
    percent: 2.47%
- - User:#:cached_follower_ids
  - keys: 577
    size: 1154
    percent: 1.73%

Overall statistics:
--------------------
used_memory:1102224
used_memory_human:1.05M</code></pre>

<p>The script: <a href='http://gist.github.com/624334'>http://gist.github.com/624334</a></p>

<pre><code>#!/usr/bin/env ruby

# Evaluates a sample of keys/values from each redis database, computing statistics for each key pattern:
#   keys: number of keys matching the given pattern
#   size: approximation of the associated memory occupied (based on size/length of value)
#   percent: the proportion of this &#39;size&#39; relative to the sample&#39;s total
#
# Copyright Weplay, Inc. 2010. Available for use under the MIT license.


require &#39;rubygems&#39;
require &#39;redis&#39;
require &#39;yaml&#39;

SAMPLE_SIZE = 10_000  # number of keys to sample from each db before computing stats


# Naive approximation of memory footprint: size/length of value.
def redis_size(db, k)
  t = db.type(k)
  case t
    when &#39;string&#39; then db.get(k).length
    when &#39;list&#39;   then db.lrange(k, 0, -1).size
    when &#39;zset&#39;   then db.zrange(k, 0, -1).size
    when &#39;set&#39;    then db.smembers(k).size
    else raise(&quot;Redis type &#39;#{t}&#39; not yet supported.&quot;)  # TODO accommodate more types
  end
end

def array_sum(array)
  array.inject(0){ |sum, e| sum + e }
end

def redis_db_profile(db_name, sample_size = SAMPLE_SIZE)
  db = Redis.new(:db =&gt; db_name)
  keys = []
  sample_size.times { |i| keys &lt;&lt; db.randomkey }
  key_patterns = keys.group_by{ |key| key.gsub(/\d+/, &#39;#&#39;) }
  data = key_patterns.map{ |pattern, keys|
    [pattern, {&#39;keys&#39; =&gt; keys.size, &#39;size&#39; =&gt; array_sum(keys.map{ |k| redis_size(db, k) })}]
  }.sort_by{ |a| a.last[&#39;size&#39;] }.reverse
  size_sum = data.inject(0){|sum, d| sum += d.last[&#39;size&#39;] }
  data.each { |d| d.last[&#39;percent&#39;] = &#39;%.2f%&#39; % (d.last[&#39;size&#39;].to_f*100/size_sum) }
end

db_names = `redis-cli info | grep ^db[0-9]`.split.map{ |line| line.scan(/^db\d+/).first }
db_names.each do |name|
  puts &quot;\nProfiling \&quot;#{name}\&quot;...\n#{&#39;-&#39;*20}&quot;
  y redis_db_profile(name)
end

puts &quot;\nOverall statistics:\n#{&#39;-&#39;*20}&quot;
puts `redis-cli info | grep memory`</code></pre>
  </article>
  
    <div class="article_footer">
      <div class="tags">
        Tags:
        <a href="/tags/programming/">programming</a>, <a href="/tags/redis/">redis</a>, <a href="/tags/ruby/">ruby</a>
      </div>
      <div class="timestamp">
        2010-10-13
      </div>
      <div class='clear'></div>
    </div>
  

      </section>
      <footer>
        <div class="col">
          <h4>Recent Articles</h4>
          <ol>
            
              
              <li><a href="/listing-mongodb-collections-by-size/">Listing MongoDB collections by size</a> <span>Sep 10</span></li>
            
              
              <li><a href="/simple-301-redirects/">Simple 301 redirects</a> <span>Jul 12</span></li>
            
              
              <li><a href="/eliminating-textmate-lag/">Eliminating TextMate Lag</a> <span>May 21</span></li>
            
              
              <li><a href="/a-search-shortcut-for-i-m-feeling-lucky/">A Search Shortcut for "I'm Feeling Lucky"</a> <span>May  1</span></li>
            
              
              <li><a href="/building-a-blog-with-middleman-and-github-pages/">Building a blog with Middleman and GitHub pages</a> <span>Apr 28</span></li>
            
          </ol>
        </div>
        <div class="col">
          <h4>Tags</h4>
          <ol>
            
              
              <li><a href="/tags/home/">home (22)</a></li>
            
              
              <li><a href="/tags/programming/">programming (16)</a></li>
            
              
              <li><a href="/tags/kitchen/">kitchen (14)</a></li>
            
              
              <li><a href="/tags/ruby/">ruby (8)</a></li>
            
              
              <li><a href="/tags/tools/">tools (6)</a></li>
            
              
              <li><a href="/tags/bathroom/">bathroom (4)</a></li>
            
              
          </ol>
        </div>
        <p>Joey Aghion &mdash; <a href="mailto:joey@aghion.com">joey@aghion.com</a></p>
      </footer>
    </div>
    <script src="/javascripts/scale.fix.js" type="text/javascript"></script>
    
    
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-10920982-2']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
